*filter

:INPUT   DROP
:OUTPUT  DROP
:FORWARD DROP

# Loopback is open.
-A INPUT  -j ACCEPT -i lo
-A OUTPUT -j ACCEPT -o lo

# Accept known connections.
-A INPUT  -j ACCEPT -m state --state ESTABLISHED,RELATED
-A OUTPUT -j ACCEPT -m state --state ESTABLISHED,RELATED

# Allowed public inbound connections. Only allow incoming requests for web
# services and wireguard VPN packets. Kubernetes requests are sent via the VPN.
-A INPUT -j ACCEPT -p icmp
-A INPUT -j ACCEPT -p tcp  --dport http  -i {{ PIF }} -m state --state NEW
-A INPUT -j ACCEPT -p tcp  --dport https -i {{ PIF }} -m state --state NEW
-A INPUT -j ACCEPT -p udp  --dport wg0   -i {{ PIF }} -m state --state NEW

# Allowed public outbound connections.
-A OUTPUT -j ACCEPT -p icmp
-A OUTPUT -j ACCEPT -p udp  --dport domain -o {{ PIF }} -m state --state NEW
-A OUTPUT -j ACCEPT -p udp  --dport ntp    -o {{ PIF }} -m state --state NEW
-A OUTPUT -j ACCEPT -p tcp  --dport http   -o {{ PIF }} -m state --state NEW
-A OUTPUT -j ACCEPT -p tcp  --dport https  -o {{ PIF }} -m state --state NEW

# Allowed VPN traffic. The server won't start outbound connection via VPN.
-A INPUT -j ACCEPT -p icmp
-A INPUT -j ACCEPT -p tcp  --dport ssh        -i wg0 -m state --state NEW
-A INPUT -j ACCEPT -p tcp  --dport http       -i wg0 -m state --state NEW
-A INPUT -j ACCEPT -p tcp  --dport https      -i wg0 -m state --state NEW
-A INPUT -j ACCEPT -p tcp  --dport postgres   -i wg0 -m state --state NEW
-A INPUT -j ACCEPT -p tcp  --dport kubernetes -i wg0 -m state --state NEW

COMMIT
